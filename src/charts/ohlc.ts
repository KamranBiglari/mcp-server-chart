import { z } from "zod";
import { zodToJsonSchema } from "../utils/index";

// Define the schema for the bar chart
// {
//   type: 'ohlc',
//   data: {
//     datasets: [
//       {
//         label: 'MSFT',
//         yAxisID: 'y1',
//         data: [
//           ['2016-04-01', 18.23, 19.36, 18.18, 19.31],
//           ['2016-04-02', 19.50, 19.89, 19.00, 19.29],
//           ['2016-04-03', 19.13, 19.15, 18.43, 18.75],
//           ['2016-04-06', 18.54, 18.76, 18.27, 18.76],
//           ['2016-04-07', 18.76, 19.14, 18.63, 18.76],
//           ['2016-04-08', 18.97, 19.62, 18.96, 19.19],
//           ['2016-04-09', 19.45, 19.70, 19.22, 19.67],
//           ['2016-04-13', 19.69, 19.85, 19.37, 19.59],
//           ['2016-04-14', 19.44, 19.55, 19.00, 19.35],
//           ['2016-04-15', 19.21, 19.25, 18.51, 18.83],
//           ['2016-04-16', 19.16, 19.78, 18.99, 19.76],
//           ['2016-04-17', 19.69, 19.69, 19.00, 19.20],
//           ['2016-04-20', 18.89, 18.95, 18.57, 18.61],
//           ['2016-04-21', 18.59, 19.08, 18.57, 18.97],
//           ['2016-04-22', 18.76, 19.19, 18.70, 18.78],
//           ['2016-04-23', 18.92, 18.94, 18.47, 18.92],
//           ['2016-04-24', 19.82, 21.20, 19.50, 20.91],
//           ['2016-04-27', 20.55, 20.82, 20.28, 20.40],
//           ['2016-04-28', 20.25, 20.27, 19.79, 19.93],
//           ['2016-04-29', 20.11, 20.89, 20.06, 20.25],
//           ['2016-04-30', 20.60, 21.10, 20.01, 20.26],
//           ['2016-05-01', 20.19, 20.35, 19.86, 20.24],
//           ['2016-05-04', 20.37, 20.40, 19.98, 20.19],
//           ['2016-05-05', 20.14, 20.24, 19.64, 19.79],
//           ['2016-05-06', 20.06, 20.07, 19.61, 19.79],
//           ['2016-05-07', 19.96, 19.99, 19.14, 19.32],
//           ['2016-05-08', 19.46, 19.64, 19.14, 19.42],
//           ['2016-05-11', 19.20, 19.73, 19.01, 19.32],
//           ['2016-05-12', 19.51, 20.06, 19.47, 19.89],
//           ['2016-05-13', 19.92, 20.00, 19.67, 19.75],
//           ['2016-05-14', 19.83, 20.23, 19.80, 20.06],
//           ['2016-05-15', 20.13, 20.50, 19.98, 20.22],
//           ['2016-05-18', 20.36, 20.60, 20.24, 20.60],
//           ['2016-05-19', 20.51, 20.74, 20.25, 20.31],
//           ['2016-05-20', 20.41, 20.69, 20.22, 20.38],
//           ['2016-05-21', 20.14, 20.23, 19.51, 19.82],
//           ['2016-05-22', 19.93, 20.17, 19.47, 19.75],
//           ['2016-05-26', 19.54, 20.45, 19.45, 20.34],
//           ['2016-05-27', 20.25, 20.60, 20.07, 20.13],
//           ['2016-05-28', 20.32, 20.63, 20.05, 20.45],
//           ['2016-05-29', 20.56, 20.94, 20.30, 20.89],
//           ['2016-06-01', 21.00, 21.50, 20.86, 21.40],
//           ['2016-06-02', 21.36, 21.98, 21.20, 21.40],
//           ['2016-06-03', 21.31, 21.76, 21.29, 21.73],
//           ['2016-06-04', 21.77, 21.90, 21.58, 21.83],
//           ['2016-06-05', 21.96, 22.31, 21.81, 22.14],
//           ['2016-06-08', 21.98, 22.32, 21.63, 22.05],
//           ['2016-06-09', 22.06, 22.32, 21.88, 22.08],
//           ['2016-06-10', 22.17, 22.62, 22.12, 22.55],
//           ['2016-06-11', 22.59, 23.26, 22.57, 22.83],
//           ['2016-06-12', 22.90, 23.38, 22.74, 23.33],
//           ['2016-06-15', 23.23, 23.54, 23.02, 23.42],
//           ['2016-06-16', 23.47, 24.11, 23.44, 23.45],
//           ['2016-06-17', 23.50, 23.82, 23.17, 23.68],
//           ['2016-06-18', 23.62, 23.69, 23.30, 23.50],
//           ['2016-06-19', 24.04, 24.34, 23.75, 24.07],
//           ['2016-06-22', 23.95, 23.95, 23.25, 23.28],
//           ['2016-06-23', 23.38, 23.66, 23.21, 23.34],
//           ['2016-06-24', 23.45, 23.75, 23.36, 23.47],
//           ['2016-06-25', 23.43, 23.92, 23.20, 23.79],
//           ['2016-06-26', 23.57, 23.69, 23.32, 23.35],
//         ].map(([d,o,h,l,c]) => ({x:new Date(d).getTime(),o,h,l,c})),
//         color: {
//           up: '#aaa',
//           down: '#000',
//           unchanged: '#ccc',
//         },
//       },
//       {
//         type: 'bar',
//         yAxisID: 'y2',
//         backgroundColor: '#bbb',
//         label: 'Volume',
//         data: [
//           ['2016-04-01', 18],
//           ['2016-04-02', 18],
//           ['2016-04-03', 18],
//           ['2016-04-06', 20],
//           ['2016-04-07', 22],
//           ['2016-04-08', 24],
//           ['2016-04-09', 22],
//           ['2016-04-13', 20],
//           ['2016-04-14', 21],
//           ['2016-04-15', 19],
//           ['2016-04-16', 21],
//           ['2016-04-17', 18],
//           ['2016-04-20', 16],
//           ['2016-04-21', 19],
//           ['2016-04-22', 16],
//           ['2016-04-23', 19],
//           ['2016-04-24', 23],
//           ['2016-04-27', 25],
//           ['2016-04-28', 27],
//           ['2016-04-29', 22],
//           ['2016-04-30', 21],
//           ['2016-05-01', 21],
//           ['2016-05-04', 21],
//           ['2016-05-05', 17],
//           ['2016-05-06', 21],
//           ['2016-05-07', 15],
//           ['2016-05-08', 22],
//           ['2016-05-11', 17],
//           ['2016-05-12', 19],
//           ['2016-05-13', 24],
//           ['2016-05-14', 22],
//           ['2016-05-15', 22],
//           ['2016-05-18', 25],
//           ['2016-05-19', 16],
//           ['2016-05-20', 20],
//           ['2016-05-21', 18],
//           ['2016-05-22', 22],
//           ['2016-05-26', 18],
//           ['2016-05-27', 25],
//           ['2016-05-28', 23],
//           ['2016-05-29', 24],
//           ['2016-06-01', 24],
//           ['2016-06-02', 22],
//           ['2016-06-03', 22],
//           ['2016-06-04', 22],
//           ['2016-06-05', 20],
//           ['2016-06-08', 20],
//           ['2016-06-09', 20],
//           ['2016-06-10', 19],
//           ['2016-06-11', 22],
//           ['2016-06-12', 23],
//           ['2016-06-15', 24],
//           ['2016-06-16', 25],
//           ['2016-06-17', 24],
//           ['2016-06-18', 24],
//           ['2016-06-19', 21],
//           ['2016-06-22', 22],
//           ['2016-06-23', 23],
//           ['2016-06-24', 22],
//           ['2016-06-25', 21],
//           ['2016-06-26', 22],
//         ].map(([d,y]) => ({x:new Date(d).getTime(),y})),
//       },
//       {
//         type: 'line',
//         yAxisID: 'y1',
//         borderColor: '#f00',
//         backgroundColor: '#f00',
//         borderWidth: 2,
//         pointRadius: 0,
//         label: 'SMA',
//         data: [
//           ['2016-04-01', 18.832],
//           ['2016-04-02', 18.98],
//           ['2016-04-03', 18.97],
//           ['2016-04-06', 19.082],
//           ['2016-04-07', 19.262],
//           ['2016-04-08', 19.352],
//           ['2016-04-09', 19.39],
//           ['2016-04-13', 19.438],
//           ['2016-04-14', 19.278],
//           ['2016-04-15', 19.108],
//           ['2016-04-16', 19.018],
//           ['2016-04-17', 18.97],
//           ['2016-04-20', 18.996],
//           ['2016-04-21', 19.328],
//           ['2016-04-22', 19.66],
//           ['2016-04-23', 19.93],
//           ['2016-04-24', 20.266],
//           ['2016-04-27', 20.34],
//           ['2016-04-28', 20.304],
//           ['2016-04-29', 20.282],
//           ['2016-04-30', 20.272],
//           ['2016-05-01', 20.144],
//           ['2016-05-04', 19.998],
//           ['2016-05-05', 19.764],
//           ['2016-05-06', 19.638],
//           ['2016-05-07', 19.61],
//           ['2016-05-08', 19.584],
//           ['2016-05-11', 19.718],
//           ['2016-05-12', 19.95],
//           ['2016-05-13', 20.15],
//           ['2016-05-14', 20.248],
//           ['2016-05-15', 20.31],
//           ['2016-05-18', 20.27],
//           ['2016-05-19', 20.106],
//           ['2016-05-20', 20.054],
//           ['2016-05-21', 20.036],
//           ['2016-05-22', 20.12],
//           ['2016-05-26', 20.334],
//           ['2016-05-27', 20.698],
//           ['2016-05-28', 20.91],
//           ['2016-05-29', 21.2],
//           ['2016-06-01', 21.48],
//           ['2016-06-02', 21.676],
//           ['2016-06-03', 21.816],
//           ['2016-06-04', 21.988],
//           ['2016-06-05', 22.152],
//           ['2016-06-08', 22.34],
//           ['2016-06-09', 22.59],
//           ['2016-06-10', 22.872],
//           ['2016-06-11', 23.138],
//           ['2016-06-12', 23.344],
//           ['2016-06-15', 23.572],
//           ['2016-06-16', 23.716],
//           ['2016-06-17', 23.698],
//           ['2016-06-18', 23.688],
//           ['2016-06-19', 23.65],
//           ['2016-06-22', 23.556],
//           ['2016-06-23', 23.486],
//           ['2016-06-24', 23.604],
//           ['2016-06-25', 23.724],
//           ['2016-06-26', 23.79],
//         ].map(([d,y]) => ({x:new Date(d).getTime(),y})),
//       },
//     ],
//   },
//   options: {
//     scales:{
//       x:{
//         adapters: {
//           date: {
//             zone: 'UTC-4'
//           }
//         },
//         time: {
//           unit: 'day',
//           stepSize: 1,
//           displayFormats: {
//             day: 'MMM d',
//             month: 'MMM d',
//           }
//         },
//       },
//       y1: {
//         stack: 'stockChart',
//         stackWeight: 10,
//         weight: 2,
//       },
//       y2: {
//         display: false,
//         stack: 'stockChart',
//         stackWeight: 1,
//         weight: 1,
//       },
//     },
//     plugins: {
//       legend: {
//         display: false,
//       },
//       title: {
//         display: true,
//         text: 'MSFT',
//         font: {
//           size: 20,
//         },
//       },
//     },
//   },
// }
const ohlcDataPointSchema = z.object({
  x: z.number(), // timestamp
  o: z.number(), // open
  h: z.number(), // high
  l: z.number(), // low
  c: z.number(), // close
});

const barDataPointSchema = z.object({
  x: z.number(), // timestamp
  y: z.number(), // value
});

const lineDataPointSchema = z.object({
  x: z.number(), // timestamp
  y: z.number(), // value
});

const colorSchema = z.object({
  up: z.string().optional(),
  down: z.string().optional(),
  unchanged: z.string().optional(),
});

const ohlcDatasetSchema = z.object({
  label: z.string(),
  yAxisID: z.string().optional(),
  data: z.array(ohlcDataPointSchema),
  color: colorSchema.optional(),
});

const barDatasetSchema = z.object({
  type: z.literal("bar"),
  yAxisID: z.string().optional(),
  backgroundColor: z.string().optional(),
  label: z.string(),
  data: z.array(barDataPointSchema),
});

const lineDatasetSchema = z.object({
  type: z.literal("line"),
  yAxisID: z.string().optional(),
  borderColor: z.string().optional(),
  backgroundColor: z.string().optional(),
  borderWidth: z.number().optional(),
  pointRadius: z.number().optional(),
  label: z.string(),
  data: z.array(lineDataPointSchema),
});

const datasetSchema = z.union([
  ohlcDatasetSchema,
  barDatasetSchema,
  lineDatasetSchema,
]);

const dateAdapterSchema = z.object({
  zone: z.string().optional(),
});

const timeConfigSchema = z.object({
  unit: z.string().optional(),
  stepSize: z.number().optional(),
  displayFormats: z.record(z.string()).optional(),
});

const scaleSchema = z.object({
  adapters: z.object({
    date: dateAdapterSchema.optional(),
  }).optional(),
  time: timeConfigSchema.optional(),
  stack: z.string().optional(),
  stackWeight: z.number().optional(),
  weight: z.number().optional(),
  display: z.boolean().optional(),
});

const legendSchema = z.object({
  display: z.boolean().optional(),
});

const titleSchema = z.object({
  display: z.boolean().optional(),
  text: z.string().optional(),
  font: z.object({
    size: z.number().optional(),
  }).optional(),
});

const pluginsSchema = z.object({
  legend: legendSchema.optional(),
  title: titleSchema.optional(),
});

const scalesSchema = z.record(scaleSchema);

const optionsSchema = z.object({
  scales: scalesSchema.optional(),
  plugins: pluginsSchema.optional(),
});

const schema = {
  type: z.literal("ohlc").default("ohlc"),
  data: z.object({
    datasets: z.array(datasetSchema),
  }),
  options: optionsSchema.optional(),
};

const tool = {
  name: "ohlc",
  description: `Generates an OHLC (Open, High, Low, Close) chart with the provided financial data.
  example input:
\`\`\`json
{
  "type": "ohlc",
  "data": {
    "datasets": [
      {
        "label": "MSFT",
        "yAxisID": "y1",
        "data": [
          {"x": 1459468800000, "o": 18.23, "h": 19.36, "l": 18.18, "c": 19.31},
          {"x": 1459555200000, "o": 19.50, "h": 19.89, "l": 19.00, "c": 19.29}
        ],
        "color": {
          "up": "#aaa",
          "down": "#000",
          "unchanged": "#ccc"
        }
      },
      {
        "type": "bar",
        "yAxisID": "y2",
        "backgroundColor": "#bbb",
        "label": "Volume",
        "data": [
          {"x": 1459468800000, "y": 18},
          {"x": 1459555200000, "y": 18}
        ]
      },
      {
        "type": "line",
        "yAxisID": "y1",
        "borderColor": "#f00",
        "backgroundColor": "#f00",
        "borderWidth": 2,
        "pointRadius": 0,
        "label": "SMA",
        "data": [
          {"x": 1459468800000, "y": 18.832},
          {"x": 1459555200000, "y": 18.98}
        ]
      }
    ]
  },
  "options": {
    "scales": {
      "x": {
        "adapters": {
          "date": {
            "zone": "UTC-4"
          }
        },
        "time": {
          "unit": "day",
          "stepSize": 1,
          "displayFormats": {
            "day": "MMM d",
            "month": "MMM d"
          }
        }
      },
      "y1": {
        "stack": "stockChart",
        "stackWeight": 10,
        "weight": 2
      },
      "y2": {
        "display": false,
        "stack": "stockChart",
        "stackWeight": 1,
        "weight": 1
      }
    },
    "plugins": {
      "legend": {
        "display": false
      },
      "title": {
        "display": true,
        "text": "MSFT",
        "font": {
          "size": 20
        }
      }
    }
  }
}
\`\`\`
  `,
  inputSchema: zodToJsonSchema(schema),
};

export const ohlc = {
  schema,
  tool,
};